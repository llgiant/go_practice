package main

import (
	"context"
	"fmt"
	"strconv"
	"time"
)

type Request struct {
	Payload string
}

type Client interface {
	SendRequest(ctx context.Context, request Request) error
	WithLimiter(ctx context.Context, requests []Request)
}

type client struct {
}

func (c *client) SendRequest(ctx context.Context, request Request) error {
	// –∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
	time.Sleep(1 * time.Second)
	fmt.Println("Request sent with payload: " + request.Payload)
	return nil
}

// –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω
var maxGoroutines = 100

func (c *client) WithLimiter(ctx context.Context, requests []Request) {
	tokens := make(chan struct{}, maxGoroutines)

	go func() {
		for range maxGoroutines {
			tokens <- struct{}{}
		}
	}()

	for _, req := range requests {
		<-tokens

		go func(r Request) {
			defer func() { tokens <- struct{}{} }()
			c.SendRequest(ctx, req)
		}(req)
	}

	for range maxGoroutines {
		<-tokens
	}
}

func main() {
	ctx := context.Background()
	c := &client{}
	requests := make([]Request, 1000)
	for i := 0; i < 1000; i++ {
		requests[i] = Request{Payload: "Request #" + strconv.Itoa(i+1)}
	}
	c.WithLimiter(ctx, requests)
}


–≠—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **—Å–µ–º–∞—Ñ–æ—Ä–∞ (semaphore)** –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω. –†–∞–∑–±–µ—Ä—É –ø–æ —à–∞–≥–∞–º:

## 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–º–∞—Ñ–æ—Ä–∞

```go
tokens := make(chan struct{}, maxGoroutines)
```

–ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –Ω–∞ 100 –º–µ—Å—Ç. –ö–∞–∂–¥—ã–π "—Ç–æ–∫–µ–Ω" (`struct{}{}`) = —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø—É—Å–∫ –≥–æ—Ä—É—Ç–∏–Ω—ã.

## 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–º–∞—Ñ–æ—Ä–∞ —Ç–æ–∫–µ–Ω–∞–º–∏

```go
go func() {
    for range maxGoroutines {
        tokens <- struct{}{}  // –∫–ª–∞–¥–µ–º 100 —Ç–æ–∫–µ–Ω–æ–≤
    }
}()
```

–û—Ç–¥–µ–ª—å–Ω–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–∞–Ω–∞–ª 100 –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏. –≠—Ç–æ –Ω–∞—á–∞–ª—å–Ω—ã–π "–ø—É–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π".

## 3. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏

```go
for _, req := range requests {
    <-tokens  // ‚Üê –ë–õ–û–ö–ò–†–£–ï–ú–°–Ø, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏–º —Ç–æ–∫–µ–Ω

    go func() {
        defer func() { tokens <- struct{}{} }()  // ‚Üê –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã
        c.SendRequest(ctx, req)
    }()
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- `<-tokens` ‚Äî **–∑–∞–±–∏—Ä–∞–µ–º —Ç–æ–∫–µ–Ω** –∏–∑ –∫–∞–Ω–∞–ª–∞ (–µ—Å–ª–∏ –∫–∞–Ω–∞–ª –ø—É—Å—Ç ‚Äî –∂–¥–µ–º)
- –ó–∞–ø—É—Å–∫–∞–µ–º –≥–æ—Ä—É—Ç–∏–Ω—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
- `defer` **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω** –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–Ω–∞–ª –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
- –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç 100 –≥–æ—Ä—É—Ç–∏–Ω, 101-–π –∑–∞–ø—Ä–æ—Å **–∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è** –Ω–∞ `<-tokens`, –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω

## 4. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω

```go
for range maxGoroutines {
    <-tokens  // –∑–∞–±–∏—Ä–∞–µ–º –≤—Å–µ 100 —Ç–æ–∫–µ–Ω–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ
}
```

–ö–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è, –≤ –∫–∞–Ω–∞–ª–µ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç 100 —Ç–æ–∫–µ–Ω–æ–≤. –ó–∞–±–∏—Ä–∞–µ–º –∏—Ö –≤—Å–µ = –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.

## –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã

```
–ù–∞—á–∞–ª–æ:
tokens: [üé´üé´üé´...üé´] (100 —Ç–æ–∫–µ–Ω–æ–≤)

–ò—Ç–µ—Ä–∞—Ü–∏—è 1-100:
tokens: [–ø—É—Å—Ç–æ] (–≤—Å–µ —Ç–æ–∫–µ–Ω—ã —Ä–æ–∑–¥–∞–Ω—ã, 100 –≥–æ—Ä—É—Ç–∏–Ω —Ä–∞–±–æ—Ç–∞—é—Ç)

–ò—Ç–µ—Ä–∞—Ü–∏—è 101:
<-tokens ‚Üê –ë–õ–û–ö–ò–†–û–í–ö–ê! –ñ–¥–µ–º, –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –≤–µ—Ä–Ω–µ—Ç —Ç–æ–∫–µ–Ω

–ì–æ—Ä—É—Ç–∏–Ω–∞ #1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å:
tokens: [üé´] (—Ç–æ–∫–µ–Ω –≤–µ—Ä–Ω—É–ª—Å—è)
‚Üí –∏—Ç–µ—Ä–∞—Ü–∏—è 101 —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞—Å—å –∏ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å

...–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
```

## –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ ‚ö†Ô∏è

–ï—Å—Ç—å **race condition** —Å –∑–∞–º—ã–∫–∞–Ω–∏–µ–º:

```go
for _, req := range requests {
    <-tokens
    go func() {
        c.SendRequest(ctx, req)  // ‚ùå req –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è!
    }()
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**

```go
for _, req := range requests {
    <-tokens
    go func(r Request) {  // ‚Üê –ø–µ—Ä–µ–¥–∞–µ–º –∫–æ–ø–∏—é
        defer func() { tokens <- struct{}{} }()
        c.SendRequest(ctx, r)
    }(req)
}
```

## –ò—Ç–æ–≥

–≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω **Worker Pool —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º**: –≤–º–µ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞ 1000 –≥–æ—Ä—É—Ç–∏–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∫–æ–¥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 100. –û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏.